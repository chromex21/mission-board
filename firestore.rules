rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Users collection
    match /users/{userId} {
      // Anyone authenticated can read user documents (needed for role checks)
      allow read: if request.auth != null;
      
      // Users can write their own document
      allow create, delete: if request.auth.uid == userId;
      
      // Users can update their own document OR other users can update friends list only
      allow update: if request.auth.uid == userId ||
        // Allow friend list updates from any authenticated user (for mutual friend requests)
        (request.auth != null && 
         request.resource.data.diff(resource.data).affectedKeys().hasOnly(['friends'])
        );
    }
    
    // Helper functions
    function isValidString(str, minLen, maxLen) {
      return str is string && str.size() >= minLen && str.size() <= maxLen;
    }
    
    function isValidMission(data) {
      return isValidString(data.title, 1, 100) &&
             isValidString(data.description, 0, 2000) &&
             data.reward is int && data.reward >= 1 && data.reward <= 10000 &&
             data.difficulty is int && data.difficulty >= 1 && data.difficulty <= 5;
    }
    
    // Missions collection
    match /missions/{missionId} {
      // Anyone authenticated can read missions
      allow read: if request.auth != null;
      
      // Only admins can create missions with valid data
      allow create: if request.auth != null && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin' &&
        isValidMission(request.resource.data);
      
      // Update rules (complex - covers accept and complete)
      allow update: if request.auth != null && (
        // Admins can do anything
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin' ||
        
        // Workers can accept OPEN missions (transition: open → assigned)
        (resource.data.status == 'open' && 
         request.resource.data.status == 'assigned' &&
         request.resource.data.assignedTo == request.auth.uid) ||
        
        // Workers can complete THEIR OWN assigned missions (transition: assigned → pending_review)
        (resource.data.status == 'assigned' && 
         resource.data.assignedTo == request.auth.uid &&
         request.resource.data.status == 'pending_review')
      );
      
      // Only admins can delete missions
      allow delete: if request.auth != null && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    // Comments collection
    match /comments/{commentId} {
      // Anyone authenticated can read comments
      allow read: if request.auth != null;
      
      // Authenticated users can create comments with valid content
      allow create: if request.auth != null && 
        request.resource.data.userId == request.auth.uid &&
        isValidString(request.resource.data.text, 1, 5000);
      
      // Users can update/delete their own comments
      allow update, delete: if request.auth != null && 
        resource.data.userId == request.auth.uid;
    }
    
    // Attachments collection
    match /attachments/{attachmentId} {
      // Anyone authenticated can read attachments
      allow read: if request.auth != null;
      
      // Authenticated users can create attachments
      allow create: if request.auth != null && 
        request.resource.data.userId == request.auth.uid;
      
      // Users can update/delete their own attachments
      allow update, delete: if request.auth != null && 
        resource.data.userId == request.auth.uid;
    }
    
    // Teams collection
    match /teams/{teamId} {
      // Anyone authenticated can read teams
      allow read: if request.auth != null;
      
      // Only admins can create teams with valid data
      allow create: if request.auth != null && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin' &&
        isValidString(request.resource.data.name, 1, 50);
      
      // Team owners or admins can update teams
      allow update: if request.auth != null && (
        resource.data.ownerId == request.auth.uid ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin'
      );
      
      // Only team owners or admins can delete teams
      allow delete: if request.auth != null && (
        resource.data.ownerId == request.auth.uid ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin'
      );
    }
    
    // Activities collection
    match /activities/{activityId} {
      // Anyone authenticated can read activities
      allow read: if request.auth != null;
      
      // Only authenticated users can create activities
      // (typically done server-side via ActivityProvider)
      allow create: if request.auth != null;
      
      // No direct updates or deletes by users
      allow update, delete: if false;
    }
    
    // Lobby collection
    match /lobby/{messageId} {
      // Anyone authenticated can read lobby messages
      allow read: if request.auth != null;
      
      // Authenticated users can create messages (content can be empty for voice/media)
      allow create: if request.auth != null && 
        request.resource.data.userId == request.auth.uid &&
        (request.resource.data.content.size() <= 1000);
      
      // Users can delete their own messages
      allow delete: if request.auth != null && 
        resource.data.userId == request.auth.uid;
      
      // Allow updates for reactions (anyone can react to messages)
      allow update: if request.auth != null;
    }
    
    // Conversations collection (Direct Messaging)
    match /conversations/{conversationId} {
      // Users can only read/write conversations they're part of
      allow read: if request.auth != null && 
        request.auth.uid in resource.data.participants;
      
      // Users can create conversations if they're one of the participants
      allow create: if request.auth != null && 
        request.auth.uid in request.resource.data.participants &&
        request.resource.data.participants.size() == 2;
      
      // Users can update conversations they're part of (for marking as read, etc.)
      allow update: if request.auth != null && 
        request.auth.uid in resource.data.participants;
      
      // Users can delete conversations they're part of
      allow delete: if request.auth != null && 
        request.auth.uid in resource.data.participants;
      
      // Messages subcollection
      match /messages/{messageId} {
        // Users can read messages in conversations they're part of
        allow read: if request.auth != null && 
          request.auth.uid in get(/databases/$(database)/documents/conversations/$(conversationId)).data.participants;
        
        // Users can create messages if they're part of the conversation and they're the sender
        allow create: if request.auth != null && 
          request.auth.uid in get(/databases/$(database)/documents/conversations/$(conversationId)).data.participants &&
          request.resource.data.senderId == request.auth.uid;
        
        // Users can update messages for read receipts, reactions, or edit their own
        allow update: if request.auth != null && 
          request.auth.uid in get(/databases/$(database)/documents/conversations/$(conversationId)).data.participants &&
          (
            // Read receipts - anyone in conversation can mark as read
            request.resource.data.diff(resource.data).affectedKeys().hasOnly(['readBy', 'isRead', 'readAt', 'deliveredAt', 'status']) ||
            // Reactions - anyone can add reactions
            request.resource.data.diff(resource.data).affectedKeys().hasOnly(['reactions']) ||
            // Edit own message content (sender only)
            (resource.data.senderId == request.auth.uid && 
             request.resource.data.diff(resource.data).affectedKeys().hasOnly(['content', 'isEdited', 'editedAt']))
          );
        
        // Users can delete their own messages
        allow delete: if request.auth != null && 
          request.auth.uid in get(/databases/$(database)/documents/conversations/$(conversationId)).data.participants &&
          resource.data.senderId == request.auth.uid;
      }
    }
    
    // Friend Requests collection
    match /friendRequests/{requestId} {
      // Users can read requests where they're sender or receiver
      allow read: if request.auth != null && (
        resource.data.senderId == request.auth.uid ||
        resource.data.receiverId == request.auth.uid
      );
      
      // Users can create requests if they're the sender
      allow create: if request.auth != null && 
        request.resource.data.senderId == request.auth.uid;
      
      // Sender can update to cancel, receiver can update to accept/reject
      allow update: if request.auth != null && (
        resource.data.senderId == request.auth.uid ||
        resource.data.receiverId == request.auth.uid
      );
      
      // Sender can delete their own pending requests (cancel)
      allow delete: if request.auth != null && 
        resource.data.senderId == request.auth.uid &&
        resource.data.status == 'pending';
    }
    
    // Blocked Users collection
    match /blockedUsers/{blockId} {
      // Users can read blocks where they're the blocker
      allow read: if request.auth != null && 
        resource.data.blockerId == request.auth.uid;
      
      // Users can create blocks if they're the blocker
      allow create: if request.auth != null && 
        request.resource.data.blockerId == request.auth.uid;
      
      // Users can delete their own blocks (unblock)
      allow delete: if request.auth != null && 
        resource.data.blockerId == request.auth.uid;
    }
    
    // Reports collection
    match /reports/{reportId} {
      // Only the reporter and admins can read reports
      allow read: if request.auth != null && (
        resource.data.reporterId == request.auth.uid ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin'
      );
      
      // Users can create reports
      allow create: if request.auth != null && 
        request.resource.data.reporterId == request.auth.uid;
      
      // Only admins can update reports (resolve them)
      allow update: if request.auth != null && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    // Notifications collection
    match /notifications/{notificationId} {
      // Users can only read their own notifications
      allow read: if request.auth != null && 
        resource.data.userId == request.auth.uid;
      
      // System creates notifications (but users can create too)
      allow create: if request.auth != null;
      
      // Users can update their own notifications (mark as read)
      allow update: if request.auth != null && 
        resource.data.userId == request.auth.uid;
      
      // Users can delete their own notifications
      allow delete: if request.auth != null && 
        resource.data.userId == request.auth.uid;
    }
    
    // Mission Activities (Feed)
    match /mission_activities/{activityId} {
      // Anyone authenticated can read activities
      allow read: if request.auth != null;
      
      // System/users can create activities
      allow create: if request.auth != null;
      
      // Users can update activities to add likes
      allow update: if request.auth != null;
      
      // Only activity owner or admin can delete
      allow delete: if request.auth != null && (
        resource.data.userId == request.auth.uid ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin'
      );
    }
    
    // App configuration (for updates)
    match /app_config/{document} {
      // Anyone can read version info
      allow read: if true;
      
      // Only admins can update version info
      allow write: if request.auth != null && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    // Release notes
    match /release_notes/{buildNumber} {
      // Anyone can read release notes
      allow read: if true;
      
      // Only admins can create/update release notes
      allow write: if request.auth != null && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    // User presence
    match /presence/{userId} {
      // Anyone authenticated can read presence
      allow read: if request.auth != null;
      
      // Users can only update their own presence
      allow write: if request.auth != null && request.auth.uid == userId;
    }
    
    // Typing indicators (subcollection under conversations)
    match /conversations/{conversationId}/typing/{userId} {
      // Participants can read typing indicators
      allow read: if request.auth != null && 
        request.auth.uid in get(/databases/$(database)/documents/conversations/$(conversationId)).data.participants;
      
      // Users can only write their own typing indicator
      allow write: if request.auth != null && request.auth.uid == userId;
    }
  }
}
